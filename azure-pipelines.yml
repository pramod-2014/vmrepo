trigger:
  branches:
    include:
      - main

stages:
  - stage: Deploy_VM
    displayName: "Terraform Apply - Create Azure VM"
    jobs:
      - job: Terraform_Apply
        displayName: "Apply Terraform Code"
        pool:
          name: 'Infra-Runners-pool'  # Your self-hosted agent pool

        steps:
          # Install Terraform
          - task: TerraformInstaller@1
            displayName: "Install Terraform"
            inputs:
              terraformVersion: '1.5.0'

          # Azure Login using Service Connection
          - task: AzureCLI@2
            displayName: 'Azure Login'
            inputs:
              azureSubscription: 'Dev-ServiceConnection'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Logged into Azure"
              addSpnToEnvironment: true

          # Set environment variables for Terraform authentication
          - powershell: |
              Write-Host "Setting environment variables for Terraform..."

              # Set environment variables for ARM Provider
              echo "##vso[task.setvariable variable=ARM_CLIENT_ID]$env:servicePrincipalId"
              echo "##vso[task.setvariable variable=ARM_CLIENT_SECRET]$env:servicePrincipalKey"
              echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$env:subscriptionId"
              echo "##vso[task.setvariable variable=ARM_TENANT_ID]$env:tenantId"

              # Also set TF_VAR_ variables for Terraform variables
              echo "##vso[task.setvariable variable=TF_VAR_client_id]$env:servicePrincipalId"
              echo "##vso[task.setvariable variable=TF_VAR_client_secret]$env:servicePrincipalKey"
              echo "##vso[task.setvariable variable=TF_VAR_subscription_id]$env:subscriptionId"
              echo "##vso[task.setvariable variable=TF_VAR_tenant_id]$env:tenantId"
            displayName: 'Set Terraform Azure credentials'

          # Terraform commands
          - script: terraform init
            displayName: "Terraform Init"

          - script: terraform validate
            displayName: "Terraform Validate"

          - script: terraform plan -out=tfplan
            displayName: "Terraform Plan"

          - script: terraform apply -auto-approve tfplan
            displayName: "Terraform Apply"
